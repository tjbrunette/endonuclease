#!/usr/bin/perl

use strict;
use warnings;
use Getopt::Long;
use WWW::Mechanize;

my %options;
$options{download} = 1;
$options{all}      = 0;

&GetOptions(
	\%options,
	"download!",
	"all!",
);

my @pdbids = @ARGV;

my $mech = WWW::Mechanize->new;
foreach my $pdbid (@pdbids) {
	my $code = lc substr($pdbid,0,4);
	my $url  = 'http://www.bmrb.wisc.edu/search/dbmatch.php?db=PDB&id=' . $code;
	$mech->get($url);

	my @links = $mech->links();
	my @wanted = 
		sort { $b->text <=> $a->text }
		grep { $_->text =~ /^\d+$/ } 
		grep { $_->url  =~ /bmrbId=\d+/ }
		@links;

	if ( $options{all} ) {
		warn "Downloading all files for $pdbid.\n";
		foreach my $link_wanted (@wanted) {
			my $bmrb_id = $link_wanted->text;
			print join ' ', ( $code, $bmrb_id );
			print "\n";
			if ( $options{download} ) {
				my $result_fn = "$bmrb_id.str";
				if ( ! -f $result_fn ) {
					download_data_from_link($bmrb_id,$result_fn);
				}
			} # download
		}
	} else {
		my $link_wanted = $wanted[0];
		if ( scalar(@wanted) == 0 ) {
			die "Error: not enough links for $pdbid at $url!\n";
		}
		if ( scalar(@wanted) > 1 ) {
			my $id_text = join ' ', ( map { $_->text } @wanted );
			warn "Warning: too many links for $pdbid at $url!\n";
			warn "Choices are: $id_text, selected ", $link_wanted->text, "\n";
		}

		my $bmrb_id = $link_wanted->text;
		print join ' ', ( $code, $bmrb_id );
		print "\n";

		if ( $options{download} ) {
			my $result_fn = "$bmrb_id.str";
			if ( ! -f $result_fn ) {
				download_data_from_link($bmrb_id,$result_fn);
			}
			#	my $dl_base = 'http://rest.bmrb.wisc.edu/bmrb/NMR-STAR2';
			#	my $dl_url = join '/', ( $dl_base, $bmrb_id );
			#	my $cmd = "wget --quiet -O $result_fn $dl_url";
			#	system($cmd);

			#	if ( ! -f $result_fn ) {
			#		die "Error downloading data for $pdbid (bmrb_id = $bmrb_id) at $url!\n";
			#	}
			#}
		} # download
	}
} # pdbids

sub download_data_from_link {
	my $bmrb_id   = shift;
	my $result_fn = shift;

	my $dl_base = 'http://rest.bmrb.wisc.edu/bmrb/NMR-STAR2';
	my $dl_url = join '/', ( $dl_base, $bmrb_id );
	my $cmd = "wget --quiet -O $result_fn $dl_url";
	my $output = `$cmd`;
	#system($cmd);

	if ( ! -f $result_fn ) {
		die "Error downloading data (bmrb_id = $bmrb_id) at $dl_url!\n";
	}
}
